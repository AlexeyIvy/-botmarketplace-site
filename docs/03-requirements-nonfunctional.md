# Нефункциональные требования (NFR)

Документ фиксирует требования к надёжности, безопасности, производительности и эксплуатационным ограничениям.
В MVP мы закладываем требования так, чтобы расширение до multi-user и real торговли не требовало переписывания базовых слоёв.

## 1) Надёжность (Reliability)

### 1.1 WebSocket устойчивость
MUST:
- Для Bybit WebSocket отправлять heartbeat `ping` каждые 20 секунд (рекомендация Bybit), иначе соединение может разрываться. 
- Реализовать автопереподключение с backoff + jitter.
- После reconnect выполнять reconciliation состояния (ордера/позиции) через REST.

### 1.2 Обработка ошибок и деградация
MUST:
- Любая ошибка торговли/состояния приводит к безопасному состоянию BotRun: `paused` или `stopped` (в зависимости от типа ошибки).
- Наличие “Stop All” (операторская кнопка).
- Все операции должны быть идемпотентны на уровне бизнес-логики (повтор запроса не должен создавать дубликат ордера/действия).

## 2) Производительность и лимиты (Performance & Limits)

### 2.1 Лимиты Bybit (учёт)
MUST:
- Соблюдать Bybit HTTP IP limit: 600 запросов в 5 секунд на IP (по умолчанию).
- Соблюдать ограничения по WebSocket соединениям: избегать частых connect/disconnect, не создавать множество соединений без необходимости.

MUST:
- Иметь внутренний троттлинг в backend (token bucket/queue) для всех вызовов к Bybit.

### 2.2 Лимиты приложения (anti-abuse)
MUST (MVP значения можно задать константами, позже — конфиг):
- Максимум активных BotRun одновременно: 1 (для одного пользователя).
- Максимальная длительность одного запуска: например 60 минут (настройка).
- Cooldown между запусками: например 1 минута.
- Лимит на количество запросов к backend per minute per user/ip.

## 3) Безопасность (Security baseline)

### 3.1 Секреты
MUST:
- Bybit API secret хранить только зашифрованным (at-rest).
- Никогда не печатать API secret в логи.
- UI никогда не получает secret обратно (только masked keyId/последние 4 символа и статус).

### 3.2 Сессии и cookies (если cookie-based auth)
MUST:
- Cookies сессии: `HttpOnly` и `Secure`, `SameSite=Lax` (или `Strict` если возможно).
- Защита от CSRF: CSRF token или другой эквивалентный механизм (в зависимости от архитектуры).

### 3.3 Авторизация на уровне объектов
MUST:
- Даже в MVP (1 пользователь) все операции проверяют object-level authorization:
  пользователь может читать/менять только свои Bot/BotRun/ExchangeConnection и т.д.
- Публичные идентификаторы ресурсов — UUID/ULID (не последовательные).

### 3.4 AI безопасность
MUST:
- LLM/AI не получает Bybit API secrets и не может инициировать торговые вызовы.
- AI генерирует только Strategy Spec и текст объяснения.
- Любое исполнение проходит через Risk/Execution слой.

## 4) Наблюдаемость (Observability)

MUST:
- Структурированные логи (JSON) с `botId`, `runId`, `intentId`, `reqId`, `env`.
- Ошибки внешних API логировать с retCode/traceId (если есть), но без чувствительных данных.
- Метрики минимум:
  - количество активных ботов,
  - количество ордеров/мин,
  - количество ошибок Bybit,
  - reconnect count WS.

SHOULD:
- Alerting (например, при частых ошибках/429/rate limit).

## 5) Совместимость и окружения (Env)

MUST:
- Конфигурация endpoint’ов Bybit по env:
  - demo: `api-demo.bybit.com`, private WS `stream-demo.bybit.com`;
  - public market data: mainnet public WS/REST.
- Конфиги и секреты хранятся вне репозитория (env vars / secret store).

## 6) Обновляемость (Maintainability)

MUST:
- Документация и код должны быть версионированы.
- Любое изменение DSL сопровождается миграцией/версионированием (`specVersion`).
- Обязательная проверка конфигов (lint/validate) перед запуском BotRun.
