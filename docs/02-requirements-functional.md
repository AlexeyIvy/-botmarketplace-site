# Функциональные требования (MVP + расширения)

Документ описывает, что должно уметь приложение с точки зрения пользователя и системы.
Формат: требования + user stories + критерии готовности.

## 1) Роли и режимы

### 1.1 Роли
- Пользователь (в MVP один пользователь, далее multi-user).
- Администратор (в MVP совпадает с пользователем): управление окружениями, стоп всех ботов, просмотр логов.

### 1.2 Режимы торговли (env)
- `demo` (MVP): Bybit Demo Trading.
- `real` (не в MVP): включается feature flag после N недель демо/тестов.

## 2) Терминал (ручная торговля)

### 2.1 Выбор рынка и инструмента
MUST:
- Пользователь выбирает категорию рынка (в MVP UI может фиксировать `linear`, но архитектурно готова к `inverse`).
- Пользователь выбирает любой `linear` инструмент из списка “instruments-info”.
- В UI есть поиск по symbol.

SHOULD:
- Показать основные параметры инструмента (tickSize, qtyStep, max/min qty), чтобы пользователь видел ограничения.

### 2.2 График и данные рынка
MUST:
- Отображать свечи (таймфрейм минимум: 1m, 5m, 15m).
- Отображать текущую цену и 24h изменения (по tickers).

SHOULD:
- Кешировать справочник инструментов и обновлять по расписанию.

### 2.3 Ордера (market/limit)
MUST:
- Создать market ордер.
- Создать limit ордер.
- Отменить ордер.
- Показать открытые ордера и историю (минимально).

ВАЖНО (асинхронность):
- Система не считает “ордер выполнен” по факту успешного ответа `Place Order`.
  Ответ означает “запрос принят”, статус нужно подтвердить через websocket/опрос. (См. Bybit docs.)

### 2.4 SL/TP (обязательно)
MUST:
- Пользователь обязан задать SL и TP для каждой позиции/стратегии в MVP.
- Режим по умолчанию: Bybit `Set Trading Stop` для позиции.
- UI должен явно показывать текущие значения SL/TP и статус их применения.

SHOULD:
- Позже дать выбор режима:
  - `bybit_trading_stop` (default)
  - `reduce_only_orders` (future)
  - `attached_on_order` (future/optional)

## 3) Подключение Bybit (Settings → Exchange)

### 3.1 Управление подключением
MUST:
- Добавить demo подключение (API key/secret).
- Проверить подключение (валидность ключа, базовый запрос).
- Показывать статус: OK / Ошибка (retCode/краткое сообщение).

MUST (безопасность):
- API secret не отображается в UI после сохранения.
- В логах секреты не печатаются.

SHOULD:
- Поддержка нескольких подключений в будущем (несколько бирж/ключей), но в MVP достаточно 1.

### 3.2 Переключение demo/real
MUST:
- В моделях данных есть `env`.
- Real скрыт feature flag.

## 4) Боты (Bots)

### 4.1 CRUD ботов
MUST:
- Создать бота: symbol, timeframe, стратегия (Strategy Spec), риск-параметры, SL/TP.
- Редактировать бота (создавая новую версию конфигурации, см. версионирование ниже).
- Удалить бота (soft delete предпочтительнее).
- Просматривать список ботов и их статус.

SHOULD:
- Версионирование конфигураций: Bot имеет `activeSpecVersion`, история версий сохраняется.

### 4.2 Запуск/остановка (Run)
MUST:
- Start (durationMinutes): запускает BotRun.
- Stop: завершает BotRun.
- Timeout stop: авто-остановка по достижению duration.
- Статусы: running / stopped / error / paused.

MUST:
- “Stop All” (админ): останавливает все активные BotRun.

### 4.3 Логи и события
MUST:
- Для каждого BotRun хранить события:
  - signal_generated
  - order_intent_created
  - order_sent
  - order_update
  - position_update
  - trading_stop_set
  - risk_blocked
  - error
  - ws_reconnect
- Логи должны иметь `runId`, `botId`, `intentId`, `reqId` (если применимо).

## 5) Strategy Builder + AI Chat

### 5.1 Конструктор стратегии (DSL)
MUST:
- Strategy Spec хранится как JSON (DSL v1).
- Валидатор проверяет:
  - symbol существует,
  - параметры в диапазоне,
  - SL/TP заданы,
  - риск-лимиты заданы,
  - частота сигналов/ордеров не превышает лимитов.

SHOULD:
- UI форма для правки ключевых параметров DSL (даже если AI сгенерировал).

### 5.2 AI-чат
MUST:
- Чат задаёт уточняющие вопросы (цель, риск, правила входа/выхода).
- На выходе AI генерирует:
  - Strategy Spec (JSON),
  - объяснение “человеческим языком”,
  - предупреждения о рисках (если стратегия опасная).

MUST (ограничения AI):
- AI не получает и не использует API ключи/секреты.
- AI не имеет прямого доступа к торговым операциям (никаких “вызовов place order” от AI).
- AI только формирует спецификацию, а исполнение контролирует Runtime+Risk.

## 6) Риск-менеджмент (MVP must-have)

MUST:
- Max position size (USDT).
- Max orders per minute.
- Cooldown между сделками.
- Max loss per run (hard stop).
- Обязательные SL/TP.

MUST:
- При превышении лимита — событие `risk_blocked` и перевод BotRun в `paused` или `stopped` (решение фиксируется в Runtime doc).

SHOULD:
- Max daily loss (future).
- Ограничение на увеличение лота (анти-мартингейл, future).

## 7) Будущие расширения (Post-MVP)

- Рынки: `inverse`, затем `spot` (и возможно `option`).
- Multi-user: регистрация, workspace, роли, подписки/лимиты.
- Портфель и PnL отчёты.
- Backtest/Replay на исторических данных.
- Advanced mode: AI генерирует код стратегии в песочнице (только после построения security sandbox).

## 8) Критерии приёмки функционала MVP

MVP считается готовым, если:
- Можно выбрать любой `linear` инструмент, увидеть цену и свечи.
- Можно подключить demo ключ, выполнить ручной market и limit ордер.
- Для позиции применяются SL/TP через trading-stop, а UI показывает их значения.
- Можно создать бота, запустить на N минут, получить лог событий и корректно завершить run по timeout.
- Нет утечек секретов в UI/логи; есть базовые лимиты и стоп-кнопка.
