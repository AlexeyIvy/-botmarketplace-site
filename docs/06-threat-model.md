# Модель угроз (Threat Model)

Документ описывает:
- активы (что защищаем),
- атакующих (кто может атаковать),
- поверхности атаки (где могут атаковать),
- ключевые сценарии,
- меры защиты и остаточные риски.

Ориентир: OWASP API Security Top 10 (2023). [web:400]

---

## 1) Активы (Assets)

Критичные активы:
- Bybit API secret пользователя (утечка = компрометация торговли).
- Возможность выставлять ордера/управлять позициями (неавторизованный трейд = прямые убытки).
- Конфигурации ботов/стратегий (интеллектуальная собственность + риск подмены).
- Журнал событий (audit trail) — нужен для расследований и отладки.
- Сессии пользователя (захват сессии = полный контроль).
- Доступ к инфраструктуре (VPS/БД/логам).

---

## 2) Потенциальные атакующие (Threat Actors)

- Внешний атакующий без аккаунта: пытается получить доступ к API или вызвать “дорогие” операции.
- Внешний атакующий с частичным доступом (например, украл cookie/токен).
- Внутренний атакующий/ошибка оператора: случайно включает real, запускает бота без лимитов.
- Supply chain: уязвимость зависимостей, утечки из CI/CD.
- “AI-угрозы”: prompt injection/социальная инженерия через чат с целью заставить систему сделать запрещённое.

---

## 3) Поверхность атаки (Attack Surface)

- Backend API (эндпоинты управления ботами, торговлей, настройками).
- AI Chat (входной текст, markdown, ссылки).
- Хранилище секретов (БД/конфиги).
- WebSocket и обработчики сообщений (парсинг, reconnect loops).
- CI/CD и репозиторий (секреты в коммитах, неправильные права).
- Nginx/серверная конфигурация и доступ к логам.

---

## 4) Ключевые угрозы и сценарии (по OWASP API Security 2023)

### 4.1 API2: Broken Authentication (компрометация аутентификации)
Сценарии:
- угадывание/перехват токенов,
- долгоживущие сессии без ротации,
- хранение токенов в небезопасном месте на клиенте.

Меры:
- сильная аутентификация, короткие TTL, ротация,
- защита cookies (HttpOnly/Secure/SameSite),
- CSRF защита.

### 4.2 API1: Broken Object Level Authorization (BOLA/IDOR)
Сценарий:
- атакующий подставляет чужой `botId`/`runId` и читает/меняет чужие данные или запускает/останавливает чужие боты.

Меры:
- object-level authorization на каждом эндпоинте,
- UUID/ULID вместо последовательных ID.

### 4.3 API4: Unrestricted Resource Consumption
Сценарии:
- спам запуска ботов или генерации AI,
- запросы “тяжёлых” данных,
- бесконечные reconnect loops на WS,
- пользователи/боты генерируют тысячи intents/ордеров.

Меры:
- rate limit и quotas на backend,
- лимиты на BotRun duration/concurrency,
- circuit breakers на внешние вызовы,
- ограничения сложности Strategy Spec.

### 4.4 API8: Security Misconfiguration
Сценарии:
- debug endpoints доступны извне,
- неправильные CORS/headers,
- открытые директории/логи,
- неправильные права на секреты.

Меры:
- hardening конфигов,
- минимизация сервисов/портов,
- запрет debug в prod,
- безопасные default headers.

### 4.5 API9: Improper Inventory Management
Сценарии:
- забытые версии API,
- неучтённые эндпоинты,
- разные поведения demo/real без документации.

Меры:
- единая документация API,
- версионирование,
- инвентаризация эндпоинтов и окружений.

---

## 5) AI-специфические угрозы

Сценарии:
- prompt injection: пользователь пытается заставить AI “показать секрет” или “выполнить торговлю”.
- XSS через markdown/HTML в сообщениях/ответах.
- утечка чувствительных данных в prompts/logs.

Меры:
- AI не получает секреты,
- AI не имеет права инициировать торговые операции,
- санитизация рендера markdown/HTML,
- redaction фильтр в логах.

---

## 6) Остаточные риски (Residual Risk)

- Биржа может вести себя иначе в real (и demo не ловит все edge cases).
- Любая автоторговля несёт финансовый риск даже при SL/TP.
- Ошибки логики стратегии могут приводить к убыткам (это не “уязвимость”, но риск продукта).

Решение:
- demo-first, ограниченные лимиты, feature flags для real,
- обязательный risk guard и стоп-кнопка,
- аудит и журналирование.

---

## 7) Что проверяем перед включением real (gate)

Real trading включается только если:
- пройдены security checklist из `docs/05-security.md`,
- покрыты критические сценарии (BOLA, rate limit, secrets redaction),
- есть ручной процесс включения (операторское подтверждение),
- настроены дополнительные лимиты и мониторинг.
