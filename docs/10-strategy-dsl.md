# Strategy DSL (MVP)

Цель: определить формат стратегии, который можно:
1) хранить в БД/репозитории,
2) валидировать,
3) безопасно исполнять ботом (без произвольного кода).

В MVP используем JSON (или YAML, который конвертируется в JSON) + JSON Schema 2020-12.

## 1) Принципы

MVP MUST:
- Стратегия — это декларативная конфигурация, без произвольных скриптов.
- Любая стратегия валидируется схемой до запуска.
- Стратегия исполняется одинаково в симуляции и в реальной торговле (demo), различается только источник исполнения.

## 2) Версионирование

MVP MUST:
- В стратегии есть `dslVersion` (семантическая/целочисленная версия).
- Бэкенд хранит и стратегию, и нормализованный конфиг (после дефолтов/миграций).

## 3) Модель стратегии (объект)

### 3.1 Общие поля

- `id` (string): внутренний идентификатор стратегии.
- `name` (string): отображаемое имя.
- `dslVersion` (int): версия DSL.
- `enabled` (bool): включена ли стратегия.
- `market` (object): рынок и символ.
- `timeframes` (array): таймфреймы, которые нужны стратегии.
- `entry` (object): правила входа.
- `risk` (object): риск-менеджмент.
- `execution` (object): правила исполнения (типы ордеров, проскальзывание, ретраи).
- `guards` (object): предохранители (лимиты, паузы, kill-switch).

### 3.2 Market

MVP:
- `exchange`: `"bybit"`
- `env`: `"demo"`
- `category`: `"linear"`
- `symbol`: например `"BTCUSDT"`

### 3.3 Entry / Exit

MVP поддерживаем 1 позицию на символ (одновременно):
- `side`: `"Buy"` или `"Sell"`
- `signal`: откуда берём сигнал (в MVP: webhook/ручной триггер/внутренний генератор).
- `order`: параметры входа (market/limit, qty/quoteQty, maxSlippageBps).

Выход:
- SL/TP обязателен (фиксированный или по ATR, но формально — декларативно).
- В MVP базовый вариант: фиксированный SL/TP в процентах или цене.

## 4) Risk management

MVP MUST:
- `maxPositionSizeUsd` (number): верхний лимит позиции.
- `riskPerTradePct` (number): риск на сделку в % от депозита (или фикс в USD — один из вариантов).
- `cooldownSeconds` (int): пауза после стопа/тейка.

MVP SHOULD:
- `dailyLossLimitUsd` (number): дневной лимит убытка (kill-switch).

## 5) Execution

MVP MUST:
- `orderType`: `"Market"` или `"Limit"`
- `reduceOnly` для закрывающих ордеров (если применимо в реализации).
- `clientOrderIdPrefix` (string) для формирования `orderLinkId` и трассировки.

## 6) Guards

MVP MUST:
- `maxOpenPositions` = 1 (на символ).
- `maxOrdersPerMinute` (int): защита от спама.
- `pauseOnError` (bool): при повторяющихся ошибках — ставим стратегию на паузу.

## 7) JSON Schema (черновик, MVP)

Файл схемы будем держать рядом в `docs/schema/strategy.schema.json`.
Диалект: JSON Schema 2020-12 (через `$schema`). [web:653][web:657]

