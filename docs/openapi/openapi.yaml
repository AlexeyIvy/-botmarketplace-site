openapi: 3.1.0
info:
  title: Bot Marketplace API (MVP)
  version: 0.1.0
  license:
    name: Proprietary
    url: ../LICENSE.md
  description: >
    MVP API for strategies, bots, and signals (demo-first).

servers:
  - url: /api

security:
  - bearerAuth: []

paths:
  /healthz:
    get:
      operationId: healthzGet
      summary: Liveness probe
      security: []
      responses:
        "200":
          description: OK
        "503":
          description: Service Unavailable
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"

  /readyz:
    get:
      operationId: readyzGet
      summary: Readiness probe
      security: []
      responses:
        "200":
          description: OK
        "503":
          description: Service Unavailable
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"

  /auth/login:
    post:
      operationId: authLogin
      summary: Login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Tokens
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          $ref: "#/components/responses/Problem"

  # ── Strategies (Stage 10 — Strategy Authoring UX) ──────────────────────────

  /strategies:
    get:
      operationId: strategiesList
      summary: List strategies in workspace
      parameters:
        - $ref: "#/components/parameters/XWorkspaceId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/StrategyView"
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"
    post:
      operationId: strategiesCreate
      summary: Create strategy (metadata only — DSL added via versions)
      parameters:
        - $ref: "#/components/parameters/XWorkspaceId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StrategyCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StrategyView"
        "400":
          $ref: "#/components/responses/Problem"
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"
        "409":
          $ref: "#/components/responses/Problem"

  /strategies/{strategyId}:
    get:
      operationId: strategiesGet
      summary: Get strategy with all versions
      parameters:
        - $ref: "#/components/parameters/XWorkspaceId"
        - name: strategyId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StrategyDetailView"
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"
        "404":
          $ref: "#/components/responses/Problem"

  /strategies/{strategyId}/versions:
    post:
      operationId: strategyVersionCreate
      summary: Create new strategy version (immutable DSL snapshot)
      description: >
        Creates a new immutable version of the strategy DSL. The DSL body is
        validated against the Strategy DSL JSON Schema (2020-12) before saving.
        Previous versions are never modified.
      parameters:
        - $ref: "#/components/parameters/XWorkspaceId"
        - name: strategyId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StrategyVersionCreateRequest"
      responses:
        "201":
          description: Version created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StrategyVersionView"
        "400":
          description: DSL schema validation error
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/ValidationProblem"
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"
        "404":
          $ref: "#/components/responses/Problem"

  /strategies/validate:
    post:
      operationId: strategiesValidate
      summary: Validate DSL body without saving
      description: >
        Validates a strategy DSL body against the Strategy DSL JSON Schema (2020-12).
        Returns { ok: true, message } on success, or 400 + field-level errors on failure.
        Does not create any records.
      parameters:
        - $ref: "#/components/parameters/XWorkspaceId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StrategyVersionCreateRequest"
      responses:
        "200":
          description: DSL is valid
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StrategyValidateResponse"
        "400":
          description: DSL schema validation error
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/ValidationProblem"
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"

  /bots:
    get:
      operationId: botsList
      summary: List bots
      responses:
        "200":
          description: OK
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"
    post:
      operationId: botsCreate
      summary: Create bot
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BotCreateRequest"
      responses:
        "201":
          description: Created
        "400":
          $ref: "#/components/responses/Problem"
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"

  /bots/{botId}/events:
    get:
      operationId: botEventsList
      summary: Bot transition/event log
      parameters:
        - name: botId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
        "401":
          $ref: "#/components/responses/Problem"
        "404":
          $ref: "#/components/responses/Problem"

  # ── Exchange Connections (Stage 8) ─────────────────────────────────────────

  /exchanges:
    get:
      operationId: exchangesList
      summary: List exchange connections (no secrets returned)
      parameters:
        - $ref: "#/components/parameters/XWorkspaceId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ExchangeConnectionView"
        "400":
          $ref: "#/components/responses/Problem"
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"
    post:
      operationId: exchangesCreate
      summary: Create exchange connection
      parameters:
        - $ref: "#/components/parameters/XWorkspaceId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExchangeConnectionCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExchangeConnectionView"
        "400":
          $ref: "#/components/responses/Problem"
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"
        "409":
          $ref: "#/components/responses/Problem"
        "500":
          $ref: "#/components/responses/Problem"

  /exchanges/{connectionId}:
    get:
      operationId: exchangesGet
      summary: Get exchange connection (no secrets returned)
      parameters:
        - $ref: "#/components/parameters/XWorkspaceId"
        - name: connectionId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExchangeConnectionView"
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"
        "404":
          $ref: "#/components/responses/Problem"
    patch:
      operationId: exchangesPatch
      summary: Update exchange connection (re-encrypts secret if provided)
      parameters:
        - $ref: "#/components/parameters/XWorkspaceId"
        - name: connectionId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExchangeConnectionPatchRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExchangeConnectionView"
        "400":
          $ref: "#/components/responses/Problem"
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"
        "404":
          $ref: "#/components/responses/Problem"
        "500":
          $ref: "#/components/responses/Problem"
    delete:
      operationId: exchangesDelete
      summary: Delete exchange connection
      parameters:
        - $ref: "#/components/parameters/XWorkspaceId"
        - name: connectionId
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: No Content
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"
        "404":
          $ref: "#/components/responses/Problem"

  /exchanges/{connectionId}/test:
    post:
      operationId: exchangesTest
      summary: Test exchange connection (demo-first)
      parameters:
        - $ref: "#/components/parameters/XWorkspaceId"
        - name: connectionId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Test result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExchangeConnectionTestResult"
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"
        "404":
          $ref: "#/components/responses/Problem"
        "500":
          $ref: "#/components/responses/Problem"

  # ── Terminal — Market Data (Stage 9a, read-only) ────────────────────────────

  /terminal/ticker:
    get:
      operationId: terminalTicker
      summary: Get current ticker for a symbol
      description: >
        Returns live ticker data (last price, bid/ask, 24h stats) for a Bybit linear
        perpetual symbol. Requires authentication. Market data is public (Bybit); no
        workspace is required.
      parameters:
        - name: symbol
          in: query
          required: true
          schema:
            type: string
            example: BTCUSDT
          description: Linear perpetual symbol (e.g. BTCUSDT)
      responses:
        "200":
          description: Ticker data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ticker"
        "400":
          $ref: "#/components/responses/Problem"
        "401":
          $ref: "#/components/responses/Problem"
        "422":
          $ref: "#/components/responses/Problem"
        "502":
          $ref: "#/components/responses/Problem"

  /terminal/candles:
    get:
      operationId: terminalCandles
      summary: Get recent OHLCV candles for a symbol
      description: >
        Returns a list of OHLCV candles from Bybit for a linear perpetual symbol.
        Requires authentication. Market data is public (Bybit); no workspace is required.
      parameters:
        - name: symbol
          in: query
          required: true
          schema:
            type: string
            example: BTCUSDT
          description: Linear perpetual symbol (e.g. BTCUSDT)
        - name: interval
          in: query
          required: false
          schema:
            type: string
            enum: ["1", "5", "15", "30", "60", "240", "D"]
            default: "15"
          description: Kline interval
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 200
          description: Number of candles to return (max 1000)
      responses:
        "200":
          description: Candles array (ascending by openTime)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Candle"
        "400":
          $ref: "#/components/responses/Problem"
        "401":
          $ref: "#/components/responses/Problem"
        "422":
          $ref: "#/components/responses/Problem"
        "502":
          $ref: "#/components/responses/Problem"

  /terminal/orders:
    post:
      operationId: terminalOrderCreate
      summary: Create manual order (Market or Limit)
      description: >
        Places a Market or Limit order on Bybit via the specified ExchangeConnection.
        Requires authentication and workspace membership.
        API key and secret are never returned.
      parameters:
        - $ref: "#/components/parameters/XWorkspaceId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateOrderRequest"
      responses:
        "201":
          description: Order submitted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TerminalOrderView"
        "400":
          $ref: "#/components/responses/Problem"
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"
        "404":
          $ref: "#/components/responses/Problem"
        "422":
          $ref: "#/components/responses/Problem"
        "502":
          $ref: "#/components/responses/Problem"
    get:
      operationId: terminalOrdersList
      summary: List recent terminal orders for workspace (latest 50)
      parameters:
        - $ref: "#/components/parameters/XWorkspaceId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TerminalOrderView"
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"

  /terminal/orders/{id}:
    get:
      operationId: terminalOrderGet
      summary: Get terminal order status (syncs with Bybit for open orders)
      parameters:
        - $ref: "#/components/parameters/XWorkspaceId"
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TerminalOrderView"
        "401":
          $ref: "#/components/responses/Problem"
        "403":
          $ref: "#/components/responses/Problem"
        "404":
          $ref: "#/components/responses/Problem"

  /signals/webhook/{strategyId}:
    post:
      operationId: signalWebhook
      summary: Webhook signal
      security: []
      parameters:
        - name: strategyId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignalRequest"
      responses:
        "202":
          description: Accepted
        "400":
          $ref: "#/components/responses/Problem"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer

  parameters:
    XWorkspaceId:
      name: X-Workspace-Id
      in: header
      required: true
      schema:
        type: string
      description: Workspace ID (membership is enforced server-side)

  responses:
    Problem:
      description: Problem Details (RFC 9457)
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"

  schemas:
    LoginRequest:
      type: object
      additionalProperties: false
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string, minLength: 1 }

    LoginResponse:
      type: object
      additionalProperties: false
      required: [accessToken, refreshToken]
      properties:
        accessToken: { type: string }
        refreshToken: { type: string }

    Problem:
      type: object
      additionalProperties: true
      required: [type, title, status]
      properties:
        type: { type: string }
        title: { type: string }
        status: { type: integer }
        detail: { type: string }
        instance: { type: string }

    # ── Strategy DSL contract (frozen, Stage 10) ──────────────────────────────

    StrategyDslBody:
      description: >
        Strategy DSL v1 body. Frozen at Stage 10.
        Full JSON Schema: docs/schema/strategy.schema.json.
        Validated with Ajv (JSON Schema 2020-12) on every save.
      type: object
      additionalProperties: false
      required: [id, name, dslVersion, enabled, market, entry, risk, execution, guards]
      properties:
        id: { type: string, minLength: 1 }
        name: { type: string, minLength: 1 }
        dslVersion: { type: integer, minimum: 1 }
        enabled: { type: boolean }
        market:
          type: object
          additionalProperties: false
          required: [exchange, env, category, symbol]
          properties:
            exchange: { type: string, enum: [bybit] }
            env: { type: string, enum: [demo] }
            category: { type: string, enum: [linear] }
            symbol: { type: string, minLength: 1 }
        timeframes:
          type: array
          items: { type: string }
        entry:
          type: object
          description: Entry signal rules (extensible in future DSL versions)
          additionalProperties: true
        risk:
          type: object
          additionalProperties: false
          required: [maxPositionSizeUsd, riskPerTradePct, cooldownSeconds]
          properties:
            maxPositionSizeUsd: { type: number, exclusiveMinimum: 0 }
            riskPerTradePct: { type: number, exclusiveMinimum: 0, maximum: 100 }
            cooldownSeconds: { type: integer, minimum: 0 }
            dailyLossLimitUsd: { type: number, minimum: 0 }
        execution:
          type: object
          additionalProperties: false
          required: [orderType, clientOrderIdPrefix]
          properties:
            orderType: { type: string, enum: [Market, Limit] }
            clientOrderIdPrefix: { type: string, minLength: 1 }
            maxSlippageBps: { type: integer, minimum: 0, maximum: 500 }
        guards:
          type: object
          additionalProperties: false
          required: [maxOpenPositions, maxOrdersPerMinute, pauseOnError]
          properties:
            maxOpenPositions: { type: integer, const: 1 }
            maxOrdersPerMinute: { type: integer, minimum: 1, maximum: 120 }
            pauseOnError: { type: boolean }

    StrategyCreateRequest:
      type: object
      additionalProperties: false
      required: [name, symbol, timeframe]
      properties:
        name: { type: string, minLength: 1, description: Display name (unique per workspace) }
        symbol: { type: string, minLength: 1, example: BTCUSDT }
        timeframe:
          type: string
          enum: [M1, M5, M15, H1]

    StrategyView:
      type: object
      additionalProperties: false
      required: [id, workspaceId, name, symbol, timeframe, status, createdAt, updatedAt]
      properties:
        id: { type: string }
        workspaceId: { type: string }
        name: { type: string }
        symbol: { type: string }
        timeframe: { type: string }
        status: { type: string, enum: [DRAFT, ACTIVE, ARCHIVED] }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    StrategyVersionView:
      type: object
      additionalProperties: false
      required: [id, strategyId, version, dslJson, executionPlanJson, createdAt]
      properties:
        id: { type: string }
        strategyId: { type: string }
        version: { type: integer, description: Monotonically increasing version number }
        dslJson:
          $ref: "#/components/schemas/StrategyDslBody"
        executionPlanJson:
          type: object
          description: Server-generated execution plan (stub in Stage 10, expanded in Stage 11)
        createdAt: { type: string, format: date-time }

    StrategyDetailView:
      allOf:
        - $ref: "#/components/schemas/StrategyView"
        - type: object
          properties:
            versions:
              type: array
              items:
                $ref: "#/components/schemas/StrategyVersionView"

    StrategyVersionCreateRequest:
      type: object
      additionalProperties: false
      required: [dslJson]
      properties:
        dslJson:
          $ref: "#/components/schemas/StrategyDslBody"

    StrategyValidateResponse:
      type: object
      additionalProperties: false
      required: [ok, message]
      properties:
        ok: { type: boolean, enum: [true] }
        message: { type: string, example: "DSL is valid" }

    ValidationProblem:
      description: >
        Problem Details (RFC 9457) extended with field-level error array.
        Each error has a field path (dot-notation pointer) and a message.
      allOf:
        - $ref: "#/components/schemas/Problem"
        - type: object
          properties:
            errors:
              type: array
              items:
                type: object
                additionalProperties: false
                required: [field, message]
                properties:
                  field: { type: string, description: "Dot-notation path e.g. 'risk.maxPositionSizeUsd'" }
                  message: { type: string }

    # ── Legacy ref (kept for backward compat in existing bot schemas) ─────────
    Strategy:
      $ref: "#/components/schemas/StrategyDslBody"

    BotCreateRequest:
      type: object
      additionalProperties: false
      required: [strategyId]
      properties:
        strategyId: { type: string }
        note: { type: string }

    ExchangeConnectionView:
      type: object
      description: >
        Safe view of an exchange connection — never includes apiKey, secret, or encryptedSecret.
      additionalProperties: false
      required: [id, workspaceId, exchange, name, status, createdAt, updatedAt]
      properties:
        id: { type: string }
        workspaceId: { type: string }
        exchange: { type: string, example: "BYBIT" }
        name: { type: string, example: "Main Bybit account" }
        status:
          type: string
          enum: [UNKNOWN, CONNECTED, FAILED]
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    ExchangeConnectionCreateRequest:
      type: object
      additionalProperties: false
      required: [exchange, name, apiKey, secret]
      properties:
        exchange: { type: string, example: "BYBIT" }
        name: { type: string, example: "Main Bybit account" }
        apiKey: { type: string, minLength: 1 }
        secret: { type: string, minLength: 1, description: "Raw secret — stored encrypted, never returned" }

    ExchangeConnectionPatchRequest:
      type: object
      additionalProperties: false
      properties:
        name: { type: string }
        apiKey: { type: string, minLength: 1 }
        secret: { type: string, minLength: 1, description: "Raw secret — re-encrypted on update, never returned" }

    ExchangeConnectionTestResult:
      type: object
      additionalProperties: false
      required: [id, status, detail]
      properties:
        id: { type: string }
        status:
          type: string
          enum: [CONNECTED, FAILED]
        detail: { type: string }

    Ticker:
      type: object
      description: Current market ticker for a linear perpetual symbol.
      additionalProperties: false
      required:
        [symbol, lastPrice, bidPrice, askPrice, prevPrice24h, price24hPcnt,
         highPrice24h, lowPrice24h, volume24h, turnover24h]
      properties:
        symbol: { type: string, example: BTCUSDT }
        lastPrice: { type: number, description: Last traded price }
        bidPrice: { type: number, description: Best bid price }
        askPrice: { type: number, description: Best ask price }
        prevPrice24h: { type: number, description: Price 24h ago }
        price24hPcnt: { type: number, description: 24h price change fraction (e.g. 0.02 = +2%) }
        highPrice24h: { type: number, description: 24h high }
        lowPrice24h: { type: number, description: 24h low }
        volume24h: { type: number, description: 24h volume in base currency }
        turnover24h: { type: number, description: 24h turnover in quote currency }

    Candle:
      type: object
      description: OHLCV candle (ascending openTime order).
      additionalProperties: false
      required: [openTime, open, high, low, close, volume]
      properties:
        openTime: { type: integer, description: Candle open timestamp in milliseconds }
        open: { type: number }
        high: { type: number }
        low: { type: number }
        close: { type: number }
        volume: { type: number, description: Volume in base currency }

    CreateOrderRequest:
      type: object
      description: >
        Payload for placing a manual terminal order.
        For LIMIT orders, price is required.
        For MARKET orders, price must not be set.
        API key / secret are resolved server-side from the ExchangeConnection.
      additionalProperties: false
      required: [exchangeConnectionId, symbol, side, type, qty]
      properties:
        exchangeConnectionId:
          type: string
          description: ID of the ExchangeConnection to use for credentials
        symbol:
          type: string
          example: BTCUSDT
        side:
          type: string
          enum: [BUY, SELL]
        type:
          type: string
          enum: [MARKET, LIMIT]
        qty:
          type: number
          description: Order quantity (positive number)
          exclusiveMinimum: 0
        price:
          type: number
          description: Required for LIMIT orders; must not be set for MARKET orders
          exclusiveMinimum: 0

    TerminalOrderView:
      type: object
      description: >
        Safe view of a terminal order. Never includes apiKey, secret, or encryptedSecret.
      additionalProperties: false
      required:
        [id, workspaceId, exchangeConnectionId, symbol, side, type, qty,
         status, createdAt, updatedAt]
      properties:
        id: { type: string }
        workspaceId: { type: string }
        exchangeConnectionId: { type: string }
        symbol: { type: string, example: BTCUSDT }
        side:
          type: string
          enum: [BUY, SELL]
        type:
          type: string
          enum: [MARKET, LIMIT]
        qty: { type: string, description: Quantity as decimal string }
        price: { type: string, nullable: true, description: Price as decimal string (null for MARKET) }
        status:
          type: string
          enum: [PENDING, SUBMITTED, FILLED, PARTIALLY_FILLED, CANCELLED, REJECTED, FAILED]
        exchangeOrderId:
          type: string
          nullable: true
          description: Exchange-assigned order ID after placement
        error:
          type: string
          nullable: true
          description: Sanitized error message if status is FAILED or REJECTED
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    SignalRequest:
      type: object
      additionalProperties: false
      required: [side, symbol, ts]
      properties:
        side:
          type: string
          enum: [Buy, Sell]
        symbol:
          type: string
        reason:
          type: string
        ts:
          type: string
          format: date-time
