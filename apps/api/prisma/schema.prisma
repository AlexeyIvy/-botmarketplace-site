generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  memberships WorkspaceMember[]
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

model Workspace {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members             WorkspaceMember[]
  strategies          Strategy[]
  bots                Bot[]
  botRuns             BotRun[]
  backtests           BacktestResult[]
  exchangeConnections ExchangeConnection[]
  terminalOrders      TerminalOrder[]
}

model WorkspaceMember {
  id          String        @id @default(uuid())
  workspaceId String
  userId      String
  role        WorkspaceRole @default(MEMBER)
  createdAt   DateTime      @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

// ── Strategy domain ──────────────────────────────────────────────

enum StrategyStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum Timeframe {
  M1
  M5
  M15
  H1
}

model Strategy {
  id          String         @id @default(uuid())
  workspaceId String
  name        String
  symbol      String
  timeframe   Timeframe
  status      StrategyStatus @default(DRAFT)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  workspace Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  versions  StrategyVersion[]
  backtests BacktestResult[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model StrategyVersion {
  id                String   @id @default(uuid())
  strategyId        String
  version           Int
  dslJson           Json
  executionPlanJson Json
  createdAt         DateTime @default(now())

  strategy Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  bots     Bot[]

  @@unique([strategyId, version])
  @@index([strategyId])
}

// ── Bot aggregate ────────────────────────────────────────────────

enum BotStatus {
  DRAFT
  ACTIVE
  DISABLED
}

model Bot {
  id                String          @id @default(uuid())
  workspaceId       String
  name              String
  strategyVersionId String
  symbol            String
  timeframe         Timeframe
  status            BotStatus       @default(DRAFT)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  workspace       Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  strategyVersion StrategyVersion @relation(fields: [strategyVersionId], references: [id], onDelete: Restrict)
  runs            BotRun[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([strategyVersionId])
  @@index([workspaceId, symbol])
}

// ── Bot runtime domain ───────────────────────────────────────────

enum BotRunState {
  CREATED
  QUEUED
  STARTING
  SYNCING
  RUNNING
  STOPPING
  STOPPED
  FAILED
  TIMED_OUT
}

model BotRun {
  id          String       @id @default(uuid())
  botId       String
  workspaceId String
  symbol      String
  state       BotRunState  @default(CREATED)
  leaseOwner  String?
  leaseUntil  DateTime?
  startedAt   DateTime?
  stoppedAt   DateTime?
  errorCode   String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  bot       Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  events    BotEvent[]
  intents   BotIntent[]

  // NOTE: partial unique index (one active run per workspace+symbol)
  // is defined in the migration SQL because Prisma cannot express
  // WHERE-filtered unique indexes.

  @@index([botId])
  @@index([workspaceId])
  @@index([workspaceId, symbol])
  @@index([state])
}

model BotEvent {
  id          String   @id @default(uuid())
  botRunId    String
  ts          DateTime @default(now())
  type        String
  payloadJson Json

  botRun BotRun @relation(fields: [botRunId], references: [id], onDelete: Cascade)

  @@index([botRunId, ts(sort: Desc)])
}

// ── Idempotency / Order intents ───────────────────────────────────

enum IntentType {
  ENTRY
  EXIT
  SL
  TP
  CANCEL
}

enum IntentState {
  PENDING
  PLACED
  FILLED
  CANCELLED
  FAILED
}

enum OrderSide {
  BUY
  SELL
}

model BotIntent {
  id          String      @id @default(uuid())
  botRunId    String
  /// Client-provided idempotency key — unique per run
  intentId    String
  /// Exchange order link ID generated server-side (sent to exchange as clientOrderId)
  orderLinkId String      @unique
  type        IntentType
  state       IntentState @default(PENDING)
  side        OrderSide
  qty         Decimal     @db.Decimal(18, 8)
  price       Decimal?    @db.Decimal(18, 8)
  /// Exchange-assigned order ID, set after placement confirmation
  orderId     String?
  /// Extra metadata (e.g., sl/tp prices, retry count, exchange response)
  metaJson    Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  botRun BotRun @relation(fields: [botRunId], references: [id], onDelete: Cascade)

  @@unique([botRunId, intentId])
  @@index([botRunId])
  @@index([orderLinkId])
  @@index([botRunId, state])
}

// ── Exchange Connections ─────────────────────────────────────────

enum ExchangeConnectionStatus {
  UNKNOWN
  CONNECTED
  FAILED
}

model ExchangeConnection {
  id               String                    @id @default(uuid())
  workspaceId      String
  exchange         String
  name             String
  apiKey           String
  encryptedSecret  String
  status           ExchangeConnectionStatus  @default(UNKNOWN)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt

  workspace      Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  terminalOrders TerminalOrder[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

// ── Terminal Orders ──────────────────────────────────────────────

enum TerminalOrderSide {
  BUY
  SELL
}

enum TerminalOrderType {
  MARKET
  LIMIT
}

enum TerminalOrderStatus {
  PENDING
  SUBMITTED
  FILLED
  PARTIALLY_FILLED
  CANCELLED
  REJECTED
  FAILED
}

model TerminalOrder {
  id                   String              @id @default(uuid())
  workspaceId          String
  exchangeConnectionId String
  symbol               String
  side                 TerminalOrderSide
  type                 TerminalOrderType
  qty                  Decimal             @db.Decimal(18, 8)
  price                Decimal?            @db.Decimal(18, 8)
  status               TerminalOrderStatus @default(PENDING)
  /// Exchange-assigned order ID returned by Bybit after placement
  exchangeOrderId      String?
  /// Sanitized error message if status = FAILED | REJECTED
  error                String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  workspace          Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  exchangeConnection ExchangeConnection @relation(fields: [exchangeConnectionId], references: [id], onDelete: Restrict)

  @@index([workspaceId])
  @@index([exchangeConnectionId])
  @@index([workspaceId, createdAt(sort: Desc)])
}

// ── Research Lab ─────────────────────────────────────────────────

enum BacktestStatus {
  PENDING
  RUNNING
  DONE
  FAILED
}

model BacktestResult {
  id           String         @id @default(uuid())
  workspaceId  String
  strategyId   String
  /// Symbol passed at request time (may differ from strategy default)
  symbol       String
  /// Bybit kline interval: "1", "5", "15", "60"
  interval     String
  fromTs       DateTime
  toTs         DateTime
  status       BacktestStatus @default(PENDING)
  /// Filled when status=DONE: { trades, wins, winrate, totalPnlPct, maxDrawdownPct, candles }
  reportJson   Json?
  errorMessage String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  strategy  Strategy  @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([strategyId])
  @@index([workspaceId, createdAt(sort: Desc)])
}
